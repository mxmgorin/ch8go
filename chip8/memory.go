package chip8

import (
	"fmt"
)

const MemorySize =	65536 // xo-chip extension, the chip8 is 4096
const ProgramStart = 0x200
const FontStart = 0x000

var font = [80]byte{
	0xF0, 0x90, 0x90, 0x90, 0xF0, // 0
	0x20, 0x60, 0x20, 0x20, 0x70, // 1
	0xF0, 0x10, 0xF0, 0x80, 0xF0, // 2
	0xF0, 0x10, 0xF0, 0x10, 0xF0, // 3
	0x90, 0x90, 0xF0, 0x10, 0x10, // 4
	0xF0, 0x80, 0xF0, 0x10, 0xF0, // 5
	0xF0, 0x80, 0xF0, 0x90, 0xF0, // 6
	0xF0, 0x10, 0x20, 0x40, 0x40, // 7
	0xF0, 0x90, 0xF0, 0x90, 0xF0, // 8
	0xF0, 0x90, 0xF0, 0x10, 0xF0, // 9
	0xF0, 0x90, 0xF0, 0x90, 0x90, // A
	0xE0, 0x90, 0xE0, 0x90, 0xE0, // B
	0xF0, 0x80, 0x80, 0x80, 0xF0, // C
	0xE0, 0x90, 0x90, 0x90, 0xE0, // D
	0xF0, 0x80, 0xF0, 0x80, 0xF0, // E
	0xF0, 0x80, 0xF0, 0x80, 0x80, // F
}

const BigFontStart = 0x050 // SCHIP font 8x10
var bigFont = [160]byte{
	// 0
	0x3C, 0x7E, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0x7E, 0x3C,
	// 1
	0x18, 0x38, 0x78, 0x18, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x7E,
	// 2
	0x3C, 0x7E, 0xE7, 0x07, 0x1E, 0x3C, 0x70, 0xE0, 0xFF, 0xFF,
	// 3
	0x3C, 0x7E, 0xE7, 0x07, 0x1E, 0x1E, 0x07, 0xE7, 0x7E, 0x3C,
	// 4
	0x0E, 0x1E, 0x3E, 0x6E, 0xCE, 0xFF, 0xFF, 0x0E, 0x0E, 0x0E,
	// 5
	0xFF, 0xFF, 0xE0, 0xFC, 0xFE, 0x07, 0x07, 0xE7, 0x7E, 0x3C,
	// 6
	0x3C, 0x7E, 0xE7, 0xE0, 0xFE, 0xFF, 0xE7, 0xE7, 0x7E, 0x3C,
	// 7
	0xFF, 0xFF, 0x07, 0x0E, 0x1C, 0x38, 0x70, 0x70, 0x70, 0x70,
	// 8
	0x3C, 0x7E, 0xE7, 0xE7, 0x7E, 0x7E, 0xE7, 0xE7, 0x7E, 0x3C,
	// 9
	0x3C, 0x7E, 0xE7, 0xE7, 0x7F, 0x3F, 0x07, 0xE7, 0x7E, 0x3C,
	// A
	0x3C, 0x7E, 0xE7, 0xE7, 0xFF, 0xFF, 0xE7, 0xE7, 0xE7, 0xE7,
	// B
	0xFE, 0xFF, 0xE7, 0xE7, 0xFE, 0xFE, 0xE7, 0xE7, 0xFF, 0xFE,
	// C
	0x3C, 0x7E, 0xE7, 0xE0, 0xE0, 0xE0, 0xE0, 0xE7, 0x7E, 0x3C,
	// D
	0xFC, 0xFE, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xFE, 0xFC,
	// E
	0xFF, 0xFF, 0xE0, 0xE0, 0xFC, 0xFC, 0xE0, 0xE0, 0xFF, 0xFF,
	// F
	0xFF, 0xFF, 0xE0, 0xE0, 0xFC, 0xFC, 0xE0, 0xE0, 0xE0, 0xE0,
}

type Memory struct {
	bytes [MemorySize]byte
}

func NewMemory() Memory {
	m := Memory{}
	m.loadFont()
	return m
}

func (m *Memory) Reset() {
	for i := range m.bytes {
		m.bytes[i] = 0
	}
}

func (m *Memory) Load(bytes []byte) error {
	if len(bytes)+ProgramStart > MemorySize {
		return fmt.Errorf("Size is too large")
	}

	copy(m.bytes[ProgramStart:], bytes)
	return nil
}

func (m *Memory) Read(addr uint16) byte {
	return m.bytes[addr]
}

func (m *Memory) Write(addr uint16, val byte) {
	m.bytes[addr] = val
}

func (m *Memory) ReadSprite(i uint16, height uint16) []byte {
	// NOTE: i and height are always valid in real CHIP-8 ROMs
	return m.bytes[i : i+height]
}

func (m *Memory) ReadU16(addr uint16) uint16 {
	hi := m.Read(addr)
	lo := m.Read(addr + 1)
	return uint16(hi)<<8 | uint16(lo)
}

func (m *Memory) loadFont() {
	copy(m.bytes[FontStart:], font[:])
	copy(m.bytes[BigFontStart:], bigFont[:])
}
