package core

import (
	"fmt"
)

const MemorySize = 4096
const ProgramStart = 0x200
const FontStart = 0x50

var font = [80]byte{
	0xF0, 0x90, 0x90, 0x90, 0xF0, // 0
	0x20, 0x60, 0x20, 0x20, 0x70, // 1
	0xF0, 0x10, 0xF0, 0x80, 0xF0, // 2
	0xF0, 0x10, 0xF0, 0x10, 0xF0, // 3
	0x90, 0x90, 0xF0, 0x10, 0x10, // 4
	0xF0, 0x80, 0xF0, 0x10, 0xF0, // 5
	0xF0, 0x80, 0xF0, 0x90, 0xF0, // 6
	0xF0, 0x10, 0x20, 0x40, 0x40, // 7
	0xF0, 0x90, 0xF0, 0x90, 0xF0, // 8
	0xF0, 0x90, 0xF0, 0x10, 0xF0, // 9
	0xF0, 0x90, 0xF0, 0x90, 0x90, // A
	0xE0, 0x90, 0xE0, 0x90, 0xE0, // B
	0xF0, 0x80, 0x80, 0x80, 0xF0, // C
	0xE0, 0x90, 0x90, 0x90, 0xE0, // D
	0xF0, 0x80, 0xF0, 0x80, 0xF0, // E
	0xF0, 0x80, 0xF0, 0x80, 0x80, // F
}

type Memory struct {
	bytes [MemorySize]byte
}

func NewMemory() *Memory {
	m := &Memory{}
	m.loadFont()
	return m
}

func (m *Memory) Load(bytes []byte) error {
	if len(bytes)+ProgramStart > MemorySize {
		return fmt.Errorf("Size is too large")
	}

	copy(m.bytes[ProgramStart:], bytes)
	return nil
}

func (m *Memory) Read(addr uint16) byte {
	return m.bytes[addr]
}

func (m *Memory) Write(addr uint16, val byte) {
	m.bytes[addr] = val
}

func (m *Memory) ReadSprite(i uint16, height uint16) []byte {
	// NOTE: i and height are always valid in real CHIP-8 ROMs
	return m.bytes[i : i+height]
}

func (m *Memory) loadFont() {
	for i, b := range font {
		m.bytes[FontStart+i] = b
	}
}
